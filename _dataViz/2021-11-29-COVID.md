---
title: "California COVID by County"
tags: epidemiology dataviz rank python matplotlib pandas
article_header:
  type: overlay
  theme: dark
  background_image:
    gradient: 'linear-gradient(135deg, rgba(0, 0, 0 , .4), rgba(0, 0, 0, .4))'
    src: /media/covid/calRank.png
cover: /media/covid/thumb.png
---

Coming soon!

<!--more-->

# Intro

One of my friends works in the California Public Health Department and sent me the link to the COVID cases datasets for the state. I'd been wanting to do some "rank plots" for a while, so I figured it was a good way to try them out.

# Dev

## Exploring data

Something to notice is that there are two categories that we should probably filter out: `Out of state` and `Unknown`. 

## Loading data

First, we setup the paths, some constants that will be useful in the analysis, and read our data file:

```python
(WIN_W, WIN_M, PERS) = (30, 30, 1e3)
(PT_ROT, FNAME) = (
    '/home/chipdelmal/Documents/COVID/', 
    'covid19cases_test.csv'
)
invalid = {'Out of state', 'Unknown'}
rawDF = pd.read_csv(path.join(PT_ROT, FNAME))
```

The first constants (`WIN_M` and `WIN_M`) are used for the "rolling average" windows (so that the ranks and trends are more stable), while `PERS` is the scaling factor for population size.

## Cleaning DataFrame

Now, we start by cleaning our dataset by transforming the dates into `datetime` objects and...

```python
countyDF = rawDF[rawDF['area_type']=='County'].drop('area_type', axis=1)
countyDF['date'] = pd.to_datetime(countyDF['date'], format='%Y-%m-%d')
```

Now, let's remove the invalid "county" tags entries by using `sets` operations:

```python
counties = set(countyDF['area'].unique())-invalid
countyDF = countyDF[countyDF['area'].isin(counties)]
```


## Pivots

```python
countyDF['casesByPop'] = PERS * (countyDF['cases'] / countyDF['population'])
countyDFPiv = countyDF.pivot(index='area', columns='date', values='casesByPop')
countyDFPiv = countyDFPiv.reset_index().set_index('area')
countyDFPiv = countyDFPiv.drop(countyDFPiv.columns[0], axis=1)
```

## Rolling Averages

```python
rolling = countyDFPiv.rolling(window=WIN_W, axis=1, min_periods=WIN_M).mean()
ranks = rolling.rank(ascending=True, method='first', axis=0)
dates = list(ranks.columns)
ranksPiv = ranks.reset_index().melt('area')
rollingPiv = rolling.reset_index().melt('area')
```

## Plots

### Ranks

<center><img width="100%" src="/media/covid/calRank.png"></center>

### Normalized Cases

<center><img width="100%" src="/media/covid/calRolling.png"></center>


### Interactive Versions

# Code Repo

* **Repository:** [Github repo](https://github.com/Chipdelmal/COVID_viz)
